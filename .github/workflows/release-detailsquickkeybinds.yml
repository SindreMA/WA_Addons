name: Release DetailsQuickKeybinds

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'DetailsQuickKeybinds/**'
      - '.github/workflows/release-detailsquickkeybinds.yml'

permissions:
  contents: write

env:
  ADDON: DetailsQuickKeybinds
  CF_PROJECT_ID: "1463125"

jobs:
  release:
    if: "!contains(github.event.head_commit.message, 'chore: bump')"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump patch version in TOC
        id: info
        run: |
          TOC="${ADDON}/${ADDON}.toc"
          OLD_VERSION=$(grep -oP '## Version: \K.*' "${TOC}" | tr -d '[:space:]')
          MAJOR=$(echo "${OLD_VERSION}" | cut -d. -f1)
          MINOR=$(echo "${OLD_VERSION}" | cut -d. -f2)
          PATCH=$(echo "${OLD_VERSION}" | cut -d. -f3)
          PATCH=$((PATCH + 1))
          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          sed -i "s/## Version: .*/## Version: ${VERSION}/" "${TOC}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "${ADDON} version: ${OLD_VERSION} -> ${VERSION}"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${ADDON}/${ADDON}.toc"
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: bump ${ADDON} to v${{ steps.info.outputs.version }}"
          git push

      - name: Package addon
        if: success()
        run: |
          cd "${ADDON}"
          zip -r "../${ADDON}.zip" . -x ".*"
          cd ..
          ls -la "${ADDON}.zip"

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ env.ADDON }}-v${{ steps.info.outputs.version }}"
          name: "${{ env.ADDON }} v${{ steps.info.outputs.version }}"
          files: "${{ env.ADDON }}.zip"
          generate_release_notes: true

      - name: Upload to CurseForge
        if: success()
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
        run: |
          VERSION="${{ steps.info.outputs.version }}"

          if [ -z "${CF_API_KEY}" ]; then
            echo "::warning::CF_API_KEY secret not set, skipping CurseForge upload"
            exit 0
          fi

          if [ "${CF_PROJECT_ID}" = "0" ]; then
            echo "::warning::CF_PROJECT_ID not set, skipping CurseForge upload"
            exit 0
          fi

          GAME_VERSIONS=$(curl -s -H "X-Api-Token: ${CF_API_KEY}" \
            "https://wow.curseforge.com/api/game/versions")

          RETAIL_VERSION_ID=$(echo "${GAME_VERSIONS}" | jq '[.[] | select(.gameVersionTypeID == 517)] | sort_by(.id) | last | .id')

          METADATA=$(cat <<'METAEOF'
          {
            "changelog": "Release VPLACEHOLDER",
            "changelogType": "text",
            "displayName": "APLACEHOLDER",
            "gameVersions": [GPLACEHOLDER],
            "releaseType": "release"
          }
          METAEOF
          )
          METADATA=$(echo "${METADATA}" | sed "s/VPLACEHOLDER/${VERSION}/;s/APLACEHOLDER/${ADDON}-${VERSION}/;s/GPLACEHOLDER/${RETAIL_VERSION_ID}/")

          echo "Uploading ${ADDON}.zip to CurseForge project ${CF_PROJECT_ID}..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "X-Api-Token: ${CF_API_KEY}" \
            -F "metadata=${METADATA}" \
            -F "file=@${ADDON}.zip" \
            "https://wow.curseforge.com/api/projects/${CF_PROJECT_ID}/upload-file")

          HTTP_CODE=$(echo "${RESPONSE}" | tail -1)
          BODY=$(echo "${RESPONSE}" | sed '$d')

          echo "Response (${HTTP_CODE}): ${BODY}"

          if [ "${HTTP_CODE}" -ge 400 ]; then
            echo "::error::CurseForge upload failed with status ${HTTP_CODE}"
            exit 1
          fi

          echo "Successfully uploaded to CurseForge!"
